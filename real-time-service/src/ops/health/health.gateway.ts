import {
  ConnectedSocket,
  SubscribeMessage,
  WebSocketGateway,
  WebSocketServer,
} from '@nestjs/websockets';
import { Server } from 'socket.io';
import { ForbiddenException, Inject, Logger, forwardRef } from '@nestjs/common';
import { AuthenticatedSocket } from 'src/common/interfaces/auth.interface';
import { getAuthenticatedUser } from 'src/common/utils/auth.utils';
import { HealthService } from './health.service';
import { HealthStatusDto } from './dto/health-status.dto';

/**
 * WebSocket gateway responsible for streaming system health updates
 * to super-admin users. Uses a single global room: `system-health`.
 *
 * @example
 * // Client emits this to start receiving health updates
 * socket.emit('ops.health.join');
 * 
 * // Client listens to this for real-time status updates
 * socket.on('ops.system.health', (payload) => { ... });
 */
@WebSocketGateway({
  cors: { origin: '*', credentials: true },
  namespace: '/events',
})
export class HealthGateway {
  private readonly logger = new Logger(HealthGateway.name);

  /**
   * WebSocket server instance injected by NestJS.
   */
  @WebSocketServer() server: Server;

  /**
   * Injects the HealthService using forwardRef to resolve circular dependency.
   */
  constructor(
    @Inject(forwardRef(() => HealthService))
    private readonly healthService: HealthService,
  ) {}

  /**
   * Handles a super-admin client subscribing to the global health stream.
   * Joins the client to a `system-health` room to receive status updates.
   *
   * @param client - The connected and authenticated WebSocket client.
   * @returns An object with `{ success: true }` or throws if unauthorized.
   */
  @SubscribeMessage('ops.health.join')
  handleJoinHealthStream(@ConnectedSocket() client: AuthenticatedSocket): {
    success: boolean;
    error?: string;
  } {
    const user = getAuthenticatedUser(client);
    const requiredPermission = 'system:health:read';

    if (!user.permissions?.includes(requiredPermission)) {
      throw new ForbiddenException(
        'You do not have permission to view system health.',
      );
    }

    const healthRoom = `system-health`;
    void client.join(healthRoom);
    this.logger.log(`Super-admin ${user.sub} joined system health stream.`);

    return { success: true };
  }

  /**
   * Public method to broadcast health status updates to all
   * clients in the `system-health` room.
   *
   * @param payload - The health status update to send.
   */
  public broadcastHealthStatus(payload: HealthStatusDto): void {
    const healthRoom = `system-health`;
    this.server.to(healthRoom).emit('ops.system.health', payload);
    this.logger.log(
      `Broadcasted system health update: ${payload.service} is ${payload.status}`,
    );
  }
}
