# user-and-org-service/Dockerfile

# ---- Base Stage ----
FROM node:18-alpine AS base
WORKDIR /usr/src/app
RUN npm install -g pnpm

# ---- Builder Stage ----
FROM base AS builder
COPY package.json pnpm-lock.yaml ./
RUN pnpm install --frozen-lockfile
COPY . .
RUN pnpm run build

# ---- Production/Runner Stage ----
FROM base AS runner

# Create a non-root user for security
RUN addgroup --system --gid 1001 nodejs && \
    adduser --system --uid 1001 nestjs

# Copy package files and prisma schema first
COPY package.json pnpm-lock.yaml ./
COPY --from=builder /usr/src/app/prisma ./prisma

# Install production dependencies (includes @prisma/client as a dependency)
RUN pnpm install --frozen-lockfile --prod

# Generate Prisma client in the runner stage (works correctly with pnpm's structure)
RUN ./node_modules/.bin/prisma generate

# Copy the compiled application code
COPY --from=builder /usr/src/app/dist ./dist

# Install curl for healthcheck
RUN apk add --no-cache curl

# Set ownership of the app directory to the non-root user
RUN chown -R nestjs:nodejs /usr/src/app

# Switch to non-root user
USER nestjs

# Expose port (non-privileged port, no issues with non-root)
EXPOSE 3001

# Run the application
CMD ["node", "dist/main.js"]
