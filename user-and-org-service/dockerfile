# user-and-org-service/Dockerfile

# ---- Base Stage ----
FROM node:18-alpine AS base
WORKDIR /usr/src/app
RUN npm install -g pnpm

# ---- Builder Stage ----
FROM base AS builder
COPY package.json pnpm-lock.yaml ./
RUN pnpm install --frozen-lockfile
COPY . .
# Generate Prisma client BEFORE build (TypeScript needs the types)
RUN ./node_modules/.bin/prisma generate
RUN pnpm run build

# Prune dev dependencies after build, keeping only production deps
RUN pnpm prune --prod

# ---- Production/Runner Stage ----
FROM base AS runner

# Create a non-root user for security
RUN addgroup --system --gid 1001 nodejs && \
    adduser --system --uid 1001 nestjs

# Copy pruned node_modules from builder (includes generated Prisma client)
COPY --from=builder /usr/src/app/node_modules ./node_modules

# Copy the compiled application code and prisma schema
COPY --from=builder /usr/src/app/dist ./dist
COPY --from=builder /usr/src/app/prisma ./prisma
COPY --from=builder /usr/src/app/package.json ./package.json

# Install curl for healthcheck
RUN apk add --no-cache curl

# Set ownership of the app directory to the non-root user
RUN chown -R nestjs:nodejs /usr/src/app

# Switch to non-root user
USER nestjs

# Expose port (non-privileged port, no issues with non-root)
EXPOSE 3001

# Run the application
CMD ["node", "dist/main.js"]
