# user-and-org-service/Dockerfile (DEFINITIVE FINAL VERSION)

# ---- Base Stage ----
FROM node:18-alpine AS base
WORKDIR /usr/src/app
RUN npm install -g pnpm

# ---- Builder Stage ----
FROM base AS builder
COPY package.json pnpm-lock.yaml ./
RUN pnpm install --frozen-lockfile
COPY . .
# This command correctly generates the client into node_modules/@prisma/client
RUN ./node_modules/.bin/prisma generate
RUN pnpm run build

# ---- Production/Runner Stage ----
FROM base AS runner
COPY package.json pnpm-lock.yaml ./
RUN pnpm install --frozen-lockfile --prod

# âœ… THE DEFINITIVE FIX:
# Copy the generated Prisma client from its ACTUAL location.
COPY --from=builder /usr/src/app/node_modules/@prisma/client ./node_modules/@prisma/client

# Copy the compiled application code and the prisma schema
COPY --from=builder /usr/src/app/dist ./dist
COPY --from=builder /usr/src/app/prisma ./prisma

EXPOSE 3001
CMD ["node", "dist/main.js"]