# Presentation Feature: Security Fixes & Download Implementation Plan

## Executive Summary
This plan addresses **critical security vulnerabilities** in the existing presentation feature and implements a new **secure download feature** allowing organizers/presenters to share downloadable presentations with attendees.

---

## Part 1: Critical Security Issues to Fix

### Issue 1: Disabled Authorization Checks (CRITICAL)
**Location:** `event-lifecycle-service/app/api/v1/endpoints/presentations.py:40-44, 105-109`

**Problem:** Authorization checks are commented out, allowing any authenticated user to upload presentations to ANY organization's sessions.

**Fix:** Uncomment and enhance authorization - verify user has `content:manage` permission OR is a speaker for the session.

### Issue 2: Path Traversal Vulnerability (HIGH)
**Location:** `event-lifecycle-service/app/api/v1/endpoints/presentations.py:58`

**Problem:** `upload_request.filename` is used directly in S3 key without sanitization.
```python
s3_key = f"uploads/presentations/{sessionId}/{upload_request.filename}"
```

**Fix:** Sanitize filename - remove path separators, limit characters to alphanumeric/underscore/hyphen/dot.

### Issue 3: Content-Type Validation (MEDIUM)
**Location:** `event-lifecycle-service/app/api/v1/endpoints/presentations.py:61`

**Problem:** Client-provided content_type is trusted without validation.

**Fix:** Validate against allowlist: `["application/pdf"]` (expandable to PPT later). why later and not now

### Issue 4: Missing File Size Limits (MEDIUM)
**Location:** `event-lifecycle-service/app/core/s3.py:generate_presigned_post()`

**Problem:** No file size constraint on S3 presigned POST.

**Fix:** Add `content-length-range` condition (e.g., max 100MB).

---

## Part 2: Download Feature Implementation

### Overview
Allow organizers/presenters to toggle a download option that makes the original presentation file available to registered attendees of that session.

### Architecture

```
┌──────────────────────────────────────────────────────────────────────────┐
│                           DOWNLOAD FEATURE FLOW                          │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  1. ORGANIZER/PRESENTER                                                  │
│     ┌─────────────────┐                                                  │
│     │ Toggle Download │                                                  │
│     │    Enabled      │                                                  │
│     └────────┬────────┘                                                  │
│              │                                                           │
│              ▼                                                           │
│  2. BACKEND API                                                          │
│     ┌─────────────────────────────────────────────────────┐             │
│     │ POST /presentation/download/toggle                   │             │
│     │ - Validates user is organizer/speaker                │             │
│     │ - Updates download_enabled in DB                     │             │
│     │ - Publishes Redis event                              │             │
│     └─────────────────────────────────────────────────────┘             │
│              │                                                           │
│              ▼                                                           │
│  3. REAL-TIME SERVICE                                                    │
│     ┌─────────────────────────────────────────────────────┐             │
│     │ Receives Redis event                                 │             │
│     │ Broadcasts to session room:                          │             │
│     │   'presentation.download.available'                  │             │
│     └─────────────────────────────────────────────────────┘             │
│              │                                                           │
│              ▼                                                           │
│  4. ATTENDEE FRONTEND                                                    │
│     ┌─────────────────────────────────────────────────────┐             │
│     │ Receives WebSocket event                             │             │
│     │ Shows download button in SlideViewer                 │             │
│     └─────────────────────────────────────────────────────┘             │
│              │                                                           │
│              ▼                                                           │
│  5. DOWNLOAD REQUEST                                                     │
│     ┌─────────────────────────────────────────────────────┐             │
│     │ GET /presentation/download-url                       │             │
│     │ - Validates user is registered for event             │             │
│     │ - Validates download is enabled                      │             │
│     │ - Generates 5-minute signed S3 URL                   │             │
│     │ - Logs download for audit                            │             │
│     │ - Returns signed URL to client                       │             │
│     └─────────────────────────────────────────────────────┘             │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

---

## Part 3: Implementation Details

### 3.1 Database Changes

**File:** `event-lifecycle-service/app/models/presentation.py`

Add columns:
```python
download_enabled = Column(Boolean, default=False, nullable=False)
original_file_key = Column(String, nullable=True)  # S3 key of original PDF
original_filename = Column(String, nullable=True)  # Original filename for download
created_at = Column(DateTime, server_default=func.now(), nullable=False)
updated_at = Column(DateTime, server_default=func.now(), onupdate=func.now(), nullable=False)
```

**Migration:** Create new Alembic migration to add these columns.

### 3.2 Backend API Changes

**File:** `event-lifecycle-service/app/api/v1/endpoints/presentations.py`

#### New Endpoint 1: Toggle Download
```
POST /organizations/{orgId}/events/{eventId}/sessions/{sessionId}/presentation/download/toggle
```
- **Auth:** JWT required
- **Authorization:** User must be organizer (org_id match) OR speaker for session
- **Request Body:** `{ "enabled": boolean }`
- **Response:** `{ "download_enabled": boolean, "message": string }`
- **Side Effect:** Publishes `presentation-download-events` to Redis

#### New Endpoint 2: Get Download URL
```
GET /organizations/{orgId}/events/{eventId}/sessions/{sessionId}/presentation/download-url
```
- **Auth:** JWT required
- **Authorization:** User must be registered for the event
- **Validation:** `download_enabled` must be `true`
- **Response:** `{ "url": string, "filename": string, "expires_in": number }`
- **Security:**
  - Signed URL expires in 5 minutes
  - Rate limit: 10 requests per user per hour
  - Audit log entry created

#### Update Existing Endpoints:
- `process_uploaded_presentation`: Store `original_file_key` and `original_filename` in DB
- `get_presentation_by_session`: Include `download_enabled` in response

### 3.3 Schema Changes

**File:** `event-lifecycle-service/app/schemas/presentation.py`

```python
class Presentation(BaseModel):
    id: str
    session_id: str
    slide_urls: List[str]
    status: str
    download_enabled: bool = False  # NEW
    original_filename: Optional[str] = None  # NEW
    created_at: Optional[datetime] = None  # NEW
    updated_at: Optional[datetime] = None  # NEW

class DownloadToggleRequest(BaseModel):
    enabled: bool

class DownloadToggleResponse(BaseModel):
    download_enabled: bool
    message: str

class DownloadUrlResponse(BaseModel):
    url: str
    filename: str
    expires_in: int  # seconds
```

### 3.4 S3 Utility Changes

**File:** `event-lifecycle-service/app/core/s3.py`

Add function:
```python
def generate_presigned_download_url(
    object_key: str,
    filename: str,
    expires_in: int = 300  # 5 minutes
) -> str:
    """Generate a presigned GET URL for secure file download."""
```

### 3.5 Real-time Service Changes

**File:** `real-time-service/src/live/content/content.gateway.ts`

Add event listener for `presentation-download-events`:
```typescript
@OnEvent('presentation-download-events')
async handleDownloadToggle(payload: { sessionId: string; downloadEnabled: boolean; filename?: string }) {
  const room = `session:${payload.sessionId}`;
  this.server.to(room).emit('presentation.download.available', {
    sessionId: payload.sessionId,
    downloadEnabled: payload.downloadEnabled,
    filename: payload.filename,
  });
}
```

Update `session.join` response to include `downloadEnabled` in presentation state.

**File:** `real-time-service/src/live/content/content.service.ts`

Update `getPresentationState()` to fetch `download_enabled` from event-lifecycle-service.

### 3.6 Frontend Changes

#### 3.6.1 Hook Updates

**File:** `globalconnect/src/hooks/use-presentation-control.ts`

Add to `SlideState` interface:
```typescript
downloadEnabled: boolean;
originalFilename?: string;
```

Add new state and handler:
```typescript
// In state
downloadEnabled: boolean;

// New event listener
newSocket.on("presentation.download.available", (data) => {
  setState(prev => ({
    ...prev,
    slideState: prev.slideState ? {
      ...prev.slideState,
      downloadEnabled: data.downloadEnabled,
      originalFilename: data.filename,
    } : null,
  }));
});
```

#### 3.6.2 Organizer UI - Download Toggle

**File:** `globalconnect/src/components/features/presentation/slide-viewer.tsx`

Add to `PresenterControlPanel`:
```tsx
// New prop
onToggleDownload?: (enabled: boolean) => Promise<void>;
downloadEnabled?: boolean;

// In component
<div className="border-t pt-4 mt-4">
  <div className="flex items-center justify-between">
    <div>
      <p className="font-medium text-sm">Allow Attendees to Download</p>
      <p className="text-xs text-muted-foreground">
        Share original presentation file with attendees
      </p>
    </div>
    <Switch
      checked={downloadEnabled}
      onCheckedChange={onToggleDownload}
    />
  </div>
</div>
```

#### 3.6.3 Attendee UI - Download Button

**File:** `globalconnect/src/components/features/presentation/slide-viewer.tsx`

Add to `SlideViewer` toolbar (for attendees only):
```tsx
{!isPresenter && slideState?.downloadEnabled && (
  <Button
    variant="ghost"
    size="sm"
    onClick={onDownload}
    className="text-white/70 hover:text-white hover:bg-white/10 gap-1.5"
  >
    <Download className="h-4 w-4" />
    <span className="hidden sm:inline text-xs">Download</span>
  </Button>
)}
```

#### 3.6.4 API Service

**File:** `globalconnect/src/services/presentation.service.ts` (NEW)

```typescript
export const presentationService = {
  async toggleDownload(
    orgId: string,
    eventId: string,
    sessionId: string,
    enabled: boolean
  ): Promise<{ download_enabled: boolean }> {
    // POST to /presentation/download/toggle
  },

  async getDownloadUrl(
    orgId: string,
    eventId: string,
    sessionId: string
  ): Promise<{ url: string; filename: string }> {
    // GET /presentation/download-url
  },
};
```

---

## Part 4: Security Measures

### 4.1 Authorization Matrix

| Action | Organizer | Speaker | Registered Attendee | Anonymous |
|--------|-----------|---------|---------------------|-----------|
| Upload presentation | YES | YES* | NO | NO |
| Toggle download | YES | YES* | NO | NO |
| View slides (live) | YES | YES | YES | NO |
| Download presentation | YES | YES | YES** | NO |

*Speaker must be assigned to the specific session
**Only when download_enabled = true

### 4.2 Rate Limiting

| Endpoint | Limit | Window |
|----------|-------|--------|
| POST /upload-request | 5 | per hour |
| POST /process | 5 | per hour |
| POST /download/toggle | 20 | per hour |
| GET /download-url | 10 | per hour |

### 4.3 Audit Logging

Log the following events:
- `presentation.uploaded` - Who uploaded, session, filename, size
- `presentation.download.toggled` - Who toggled, session, new state
- `presentation.downloaded` - Who downloaded, session, timestamp

---

## Part 5: File Changes Summary

### Backend (event-lifecycle-service)

| File | Action | Description |
|------|--------|-------------|
| `app/models/presentation.py` | MODIFY | Add download_enabled, original_file_key, timestamps |
| `app/schemas/presentation.py` | MODIFY | Add new fields and DTOs |
| `app/api/v1/endpoints/presentations.py` | MODIFY | Fix security, add 2 new endpoints |
| `app/core/s3.py` | MODIFY | Add presigned download URL function |
| `app/tasks.py` | MODIFY | Store original_file_key after processing |
| `app/crud/crud_presentation.py` | MODIFY | Add toggle_download method |
| `alembic/versions/xxx_add_download_fields.py` | CREATE | Migration for new columns |

### Real-time Service

| File | Action | Description |
|------|--------|-------------|
| `src/live/content/content.gateway.ts` | MODIFY | Add download event handler |
| `src/live/content/content.service.ts` | MODIFY | Include download_enabled in state |
| `src/live/content/dto/download-event.dto.ts` | CREATE | DTO for download events |

### Frontend (globalconnect)

| File | Action | Description |
|------|--------|-------------|
| `src/hooks/use-presentation-control.ts` | MODIFY | Add download state and events |
| `src/components/features/presentation/slide-viewer.tsx` | MODIFY | Add download toggle and button |
| `src/services/presentation.service.ts` | CREATE | API service for presentation |
| `src/app/(platform)/dashboard/events/[eventId]/_components/session-item.tsx` | MODIFY | Pass download toggle handler |

---

## Part 6: Testing Checklist

### Security Tests
- [ ] Verify unauthorized users cannot upload presentations
- [ ] Verify path traversal in filename is blocked
- [ ] Verify only PDF content type is accepted
- [ ] Verify file size limit is enforced
- [ ] Verify download URL expires after 5 minutes
- [ ] Verify unregistered users cannot download
- [ ] Verify download is blocked when download_enabled=false

### Functional Tests
- [ ] Organizer can toggle download on/off
- [ ] Speaker assigned to session can toggle download
- [ ] Attendees see download button when enabled
- [ ] Download button disappears when disabled (real-time)
- [ ] Downloaded file matches original upload
- [ ] Download works on mobile browsers

### Performance Tests
- [ ] Large file upload (100MB) completes successfully
- [ ] Multiple concurrent downloads don't overload S3
- [ ] WebSocket broadcast reaches all attendees in room

---

## Part 7: Rollout Plan

1. **Phase 1:** Deploy security fixes (no user-facing changes)
2. **Phase 2:** Deploy database migration
3. **Phase 3:** Deploy backend API changes
4. **Phase 4:** Deploy real-time service changes
5. **Phase 5:** Deploy frontend changes (feature flag optional)
6. **Phase 6:** Monitor and collect feedback

---

## Estimated Changes

- **Backend:** ~250 lines added/modified
- **Real-time Service:** ~50 lines added/modified
- **Frontend:** ~150 lines added/modified
- **Tests:** ~200 lines new tests
